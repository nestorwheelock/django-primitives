<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visit - {{ visit.patient.name }}</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; }
        .header { background: #2563eb; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; }
        .state-badge { background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; text-transform: uppercase; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1rem; margin-bottom: 1rem; }
        .card h2 { font-size: 1rem; color: #666; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .btn { display: inline-block; padding: 0.5rem 1rem; background: #2563eb; color: white; text-decoration: none; border-radius: 4px; font-size: 0.9rem; border: none; cursor: pointer; margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .btn:hover { background: #1d4ed8; }
        .btn.secondary { background: #6b7280; }
        .btn.secondary:hover { background: #4b5563; }
        .btn.danger { background: #dc2626; }
        .btn.danger:hover { background: #b91c1c; }
        .btn.success { background: #16a34a; }
        .btn.success:hover { background: #15803d; }
        .info-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #eee; }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: #666; }
        .basket-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #eee; }
        .work-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #eee; }
        .work-status { font-size: 0.8rem; padding: 0.2rem 0.5rem; border-radius: 4px; background: #fef3c7; color: #92400e; }
        .work-status.completed { background: #dcfce7; color: #166534; }
        .work-board { font-size: 0.8rem; color: #666; }
        select { padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-right: 0.5rem; }
        .nav-links { margin-top: 1rem; }
        .nav-links a { color: #2563eb; text-decoration: none; margin-right: 1rem; }
        .nav-links a:hover { text-decoration: underline; }
        .transition-buttons { margin-top: 1rem; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Visit: {{ visit.patient.name }}</h1>
        <span class="state-badge">{{ visit.state }}</span>
    </div>

    <div class="container">
        <div class="card">
            <h2>Visit Progress</h2>
            <p style="margin-bottom: 1rem;">Current state: <strong>{{ visit.state|upper }}</strong></p>

            <div class="transition-buttons">
                {% for next_state in visit.allowed_transitions %}
                    {% if next_state == "cancelled" %}
                    <button class="btn danger" onclick="transitionTo('{{ next_state }}')">Cancel Visit</button>
                    {% else %}
                    <button class="btn success" onclick="transitionTo('{{ next_state }}')">Move to {{ next_state|title }}</button>
                    {% endif %}
                {% empty %}
                <p style="color: #666;">This visit is in a terminal state (no further transitions allowed).</p>
                {% endfor %}
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>Patient Info</h2>
                <div class="info-row">
                    <span class="info-label">Name</span>
                    <span>{{ visit.patient.name }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Patient ID</span>
                    <span style="font-family: monospace;">{{ visit.patient.id|truncatechars:12 }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Visit Created</span>
                    <span>{{ encounter.created_at|date:"M j, Y H:i" }}</span>
                </div>
            </div>

            <div class="card">
                <h2>Add to Basket</h2>
                <form onsubmit="addToBasket(event)">
                    <select id="catalog-item" required>
                        <option value="">Select item...</option>
                        {% for item in catalog_items %}
                        <option value="{{ item.pk }}">{{ item.display_name }} ({{ item.kind }})</option>
                        {% endfor %}
                    </select>
                    <input type="number" id="quantity" value="1" min="1" style="width: 60px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    <button type="submit" class="btn">Add</button>
                </form>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>Basket ({{ visit.basket.status|default:"No basket" }})</h2>
                {% for item in visit.basket.items %}
                <div class="basket-item">
                    <span>{{ item.catalog_item__display_name }}</span>
                    <span>x{{ item.quantity }}</span>
                </div>
                {% empty %}
                <p style="color: #666;">No items in basket.</p>
                {% endfor %}

                {% if visit.basket.items %}
                <div style="margin-top: 1rem;">
                    <button class="btn success" onclick="commitBasket()">Commit Basket</button>
                </div>
                {% endif %}
            </div>

            <div class="card">
                <h2>Work Items</h2>
                {% for item in visit.work_items %}
                <div class="work-item">
                    <div>
                        <span>{{ item.display_name }}</span>
                        <span class="work-board">[{{ item.target_board }}]</span>
                    </div>
                    <span class="work-status {% if item.status == 'completed' %}completed{% endif %}">{{ item.status }}</span>
                </div>
                {% empty %}
                <p style="color: #666;">No work items yet. Commit basket to spawn work items.</p>
                {% endfor %}
            </div>
        </div>

        <div class="nav-links">
            <a href="{% url 'clinic:dashboard' %}">Back to Dashboard</a>
            <a href="{% url 'clinic:patient_list' %}">Patient List</a>
            <a href="{% url 'index' %}">Back to Testbed Home</a>
        </div>
    </div>

    <script>
        const visitId = '{{ visit.id }}';

        function transitionTo(state) {
            fetch(`/clinic/api/visits/${visitId}/transition/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ to_state: state })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    location.reload();
                }
            })
            .catch(err => alert('Error: ' + err));
        }

        function addToBasket(event) {
            event.preventDefault();
            const catalogItemId = document.getElementById('catalog-item').value;
            const quantity = document.getElementById('quantity').value;

            fetch(`/clinic/api/visits/${visitId}/basket/items/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ catalog_item_id: catalogItemId, quantity: parseInt(quantity) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    location.reload();
                }
            })
            .catch(err => alert('Error: ' + err));
        }

        function commitBasket() {
            fetch(`/clinic/api/visits/${visitId}/basket/commit/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    location.reload();
                }
            })
            .catch(err => alert('Error: ' + err));
        }
    </script>
</body>
</html>
