{% extends "diveops/staff/_base.html" %}
{% load portal_ui_tags %}

{% block breadcrumb %}
<li>
    <div class="flex items-center">
        <svg class="flex-shrink-0 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <span class="ml-2 text-sm font-medium text-gray-500">AI Settings</span>
    </div>
</li>
{% endblock %}

{% block staff_content %}
<div class="max-w-2xl mx-auto space-y-6">
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-900">{{ page_title }}</h1>
        {% if is_configured %}
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
            {% icon "check-circle" "w-4 h-4 mr-1" %}
            Configured
        </span>
        {% else %}
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
            {% icon "exclamation-triangle" "w-4 h-4 mr-1" %}
            Not Configured
        </span>
        {% endif %}
    </div>

    <form method="post" class="space-y-6">
        {% csrf_token %}

        <!-- API Keys Section -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-medium text-gray-900">API Keys</h3>
                <p class="mt-1 text-sm text-gray-500">Configure API keys for AI services. Database values take precedence over environment variables.</p>
            </div>
            <div class="px-6 py-4 space-y-4">
                <!-- OpenRouter API Key -->
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <label for="openrouter_api_key" class="block text-sm font-medium text-gray-700">OpenRouter API Key</label>
                        {% if openrouter_source == 'database' %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                            From Database
                        </span>
                        {% elif openrouter_source == 'environment' %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                            From Environment
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">
                            Not Set
                        </span>
                        {% endif %}
                    </div>
                    <div class="flex gap-2">
                        <input type="password" name="openrouter_api_key" id="openrouter_api_key"
                               placeholder="{% if openrouter_source != 'default' %}*** Key is set ***{% else %}sk-or-v1-...{% endif %}"
                               class="block flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        {% if openrouter_source == 'database' %}
                        <label class="inline-flex items-center text-sm text-gray-600">
                            <input type="checkbox" name="clear_openrouter" class="rounded border-gray-300 text-red-600 focus:ring-red-500 mr-1">
                            Clear
                        </label>
                        {% endif %}
                    </div>
                    <p class="mt-1 text-xs text-gray-500">Used for text extraction and OCR enhancement. Leave blank to keep existing value.</p>
                </div>

                <!-- OpenAI API Key -->
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <label for="openai_api_key" class="block text-sm font-medium text-gray-700">OpenAI API Key</label>
                        {% if openai_source == 'database' %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                            From Database
                        </span>
                        {% elif openai_source == 'environment' %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                            From Environment
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">
                            Not Set
                        </span>
                        {% endif %}
                    </div>
                    <div class="flex gap-2">
                        <input type="password" name="openai_api_key" id="openai_api_key"
                               placeholder="{% if openai_source != 'default' %}*** Key is set ***{% else %}sk-...{% endif %}"
                               class="block flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        {% if openai_source == 'database' %}
                        <label class="inline-flex items-center text-sm text-gray-600">
                            <input type="checkbox" name="clear_openai" class="rounded border-gray-300 text-red-600 focus:ring-red-500 mr-1">
                            Clear
                        </label>
                        {% endif %}
                    </div>
                    <p class="mt-1 text-xs text-gray-500">Alternative AI provider. Leave blank to keep existing value.</p>
                </div>
            </div>
        </div>

        <!-- Model Configuration -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-medium text-gray-900">Model Configuration</h3>
            </div>
            <div class="px-6 py-4 space-y-4">
                <div>
                    <label for="default_model" class="block text-sm font-medium text-gray-700 mb-1">Default Model</label>
                    <select name="default_model" id="default_model"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <optgroup label="Anthropic (via OpenRouter)">
                            <option value="anthropic/claude-3-haiku" {% if settings.default_model == 'anthropic/claude-3-haiku' %}selected{% endif %}>Claude 3 Haiku (Fast & Cheap)</option>
                            <option value="anthropic/claude-3-sonnet" {% if settings.default_model == 'anthropic/claude-3-sonnet' %}selected{% endif %}>Claude 3 Sonnet (Balanced)</option>
                            <option value="anthropic/claude-3-opus" {% if settings.default_model == 'anthropic/claude-3-opus' %}selected{% endif %}>Claude 3 Opus (Most Capable)</option>
                        </optgroup>
                        <optgroup label="OpenAI (via OpenRouter)">
                            <option value="openai/gpt-4o-mini" {% if settings.default_model == 'openai/gpt-4o-mini' %}selected{% endif %}>GPT-4o Mini (Fast & Cheap)</option>
                            <option value="openai/gpt-4o" {% if settings.default_model == 'openai/gpt-4o' %}selected{% endif %}>GPT-4o (Balanced)</option>
                            <option value="openai/gpt-4-turbo" {% if settings.default_model == 'openai/gpt-4-turbo' %}selected{% endif %}>GPT-4 Turbo</option>
                        </optgroup>
                        <optgroup label="Google (via OpenRouter)">
                            <option value="google/gemini-flash-1.5" {% if settings.default_model == 'google/gemini-flash-1.5' %}selected{% endif %}>Gemini 1.5 Flash (Fast)</option>
                            <option value="google/gemini-pro-1.5" {% if settings.default_model == 'google/gemini-pro-1.5' %}selected{% endif %}>Gemini 1.5 Pro</option>
                        </optgroup>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">Model used for document text extraction and processing.</p>
                </div>
            </div>
        </div>

        <!-- Feature Flags -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-medium text-gray-900">Feature Settings</h3>
            </div>
            <div class="px-6 py-4 space-y-4">
                <div class="flex items-start">
                    <div class="flex items-center h-5">
                        <input type="checkbox" name="ocr_enhancement_enabled" id="ocr_enhancement_enabled"
                               {% if settings.ocr_enhancement_enabled %}checked{% endif %}
                               class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    </div>
                    <div class="ml-3">
                        <label for="ocr_enhancement_enabled" class="text-sm font-medium text-gray-700">OCR Enhancement</label>
                        <p class="text-xs text-gray-500">Use AI to improve OCR results from scanned documents</p>
                    </div>
                </div>

                <div class="flex items-start">
                    <div class="flex items-center h-5">
                        <input type="checkbox" name="auto_extract_enabled" id="auto_extract_enabled"
                               {% if settings.auto_extract_enabled %}checked{% endif %}
                               class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    </div>
                    <div class="ml-3">
                        <label for="auto_extract_enabled" class="text-sm font-medium text-gray-700">Auto-Extract on Upload</label>
                        <p class="text-xs text-gray-500">Automatically extract text when documents are uploaded</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Box -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    {% icon "info" "h-5 w-5 text-blue-400" %}
                </div>
                <div class="ml-3">
                    <h4 class="text-sm font-medium text-blue-800">Configuration Priority</h4>
                    <ul class="mt-2 text-sm text-blue-700 space-y-1">
                        <li><strong>Database:</strong> Values saved here take highest priority</li>
                        <li><strong>Environment:</strong> Falls back to .env file if database is empty</li>
                        <li><strong>Default:</strong> Uses built-in defaults if neither is set</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex justify-end space-x-3">
            <a href="{% url 'diveops:dashboard' %}"
               class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                Cancel
            </a>
            <button type="submit"
                    class="px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                Save Settings
            </button>
        </div>
    </form>
</div>
{% endblock %}
