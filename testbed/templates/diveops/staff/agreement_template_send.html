{% extends "diveops/staff/_base.html" %}
{% load portal_ui_tags %}

{% block breadcrumb %}
<li>
    <div class="flex items-center">
        <svg class="flex-shrink-0 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <a href="{% url 'diveops:agreement-template-list' %}" class="ml-2 text-sm font-medium text-gray-500 hover:text-gray-700">
            Agreement Templates
        </a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <svg class="flex-shrink-0 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <a href="{% url 'diveops:agreement-template-detail' pk=template.pk %}" class="ml-2 text-sm font-medium text-gray-500 hover:text-gray-700">
            {{ template.name }}
        </a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <svg class="flex-shrink-0 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <span class="ml-2 text-sm font-medium text-gray-500">Send</span>
    </div>
</li>
{% endblock %}

{% block staff_content %}
<div class="max-w-2xl mx-auto">
    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Send Agreement</h1>
        <p class="text-gray-600 mt-1">Send "{{ template.name }}" to a party for signing</p>
    </div>

    <!-- Send Form Card -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h2 class="text-lg font-medium text-gray-900">Recipient & Delivery</h2>
        </div>
        <div class="px-6 py-6">
            <form method="post">
                {% csrf_token %}

                <!-- Party Selection -->
                <div class="mb-6">
                    <label for="party_id" class="block text-sm font-medium text-gray-700 mb-2">
                        Select {{ party_type_label }} <span class="text-red-500">*</span>
                    </label>
                    <select name="party_id" id="party_id" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Select a {{ party_type_label|lower }} --</option>
                        {% for party in parties %}
                        <option value="{{ party.pk }}">
                            {% if is_organization %}
                            {{ party.name }}
                            {% else %}
                            {{ party.last_name }}, {{ party.first_name }}
                            {% if party.email %}({{ party.email }}){% endif %}
                            {% endif %}
                        </option>
                        {% empty %}
                        <option value="" disabled>No {{ party_type_label|lower }}s available</option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-xs text-gray-500">
                        Choose the {{ party_type_label|lower }} who will receive and sign this agreement.
                    </p>
                    {% if not parties %}
                    <p class="mt-2 text-sm text-amber-600">
                        <svg class="inline h-4 w-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        No {{ party_type_label|lower }}s found.
                        {% if party_type_label == "Diver" %}
                        Create diver profiles first.
                        {% elif party_type_label == "Employee" %}
                        Add employees with an active employment relationship to your shop.
                        {% elif party_type_label == "Vendor" %}
                        Add vendors with an active vendor relationship to your shop.
                        {% endif %}
                    </p>
                    {% endif %}
                </div>

                <!-- Delivery Method -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Delivery Method <span class="text-red-500">*</span>
                    </label>
                    <div class="space-y-3">
                        {% for value, label in delivery_methods %}
                        <label class="flex items-start cursor-pointer">
                            <input type="radio" name="delivery_method" value="{{ value }}"
                                   {% if forloop.first %}checked{% endif %}
                                   class="mt-1 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-3">
                                <span class="block text-sm font-medium text-gray-900">{{ label }}</span>
                                {% if value == "email" %}
                                <span class="block text-xs text-gray-500">An email with the signing link will be sent to the recipient.</span>
                                {% elif value == "link" %}
                                <span class="block text-xs text-gray-500">Generate a link that you can share manually (via SMS, message, etc.).</span>
                                {% else %}
                                <span class="block text-xs text-gray-500">For signing on a shared device or tablet present at your location.</span>
                                {% endif %}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Expiration -->
                <div class="mb-6">
                    <label for="expires_in_days" class="block text-sm font-medium text-gray-700 mb-2">
                        Expires In
                    </label>
                    <div class="flex items-center space-x-2">
                        <input type="number" name="expires_in_days" id="expires_in_days" value="30" min="1" max="365"
                               class="w-24 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <span class="text-sm text-gray-600">days</span>
                    </div>
                    <p class="mt-1 text-xs text-gray-500">
                        How long the signing link will be valid. After expiration, the agreement cannot be signed.
                    </p>
                </div>

                <!-- Include Message -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Include Message (Optional)
                    </label>
                    <input type="hidden" name="message_type" id="message_type" value="none">
                    <input type="hidden" name="canned_response_id" id="canned_response_id" value="">

                    <div class="space-y-3">
                        <!-- No message option -->
                        <label class="flex items-start cursor-pointer">
                            <input type="radio" name="message_option" value="none" checked
                                   onchange="selectMessageType('none')"
                                   class="mt-1 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-3">
                                <span class="block text-sm font-medium text-gray-900">No message</span>
                                <span class="block text-xs text-gray-500">Just send the agreement link without a cover message.</span>
                            </span>
                        </label>

                        <!-- Canned response option -->
                        <label class="flex items-start cursor-pointer">
                            <input type="radio" name="message_option" value="canned"
                                   onchange="selectMessageType('canned')"
                                   class="mt-1 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-3">
                                <span class="block text-sm font-medium text-gray-900">Use a template message</span>
                                <span class="block text-xs text-gray-500">Choose from pre-written messages.</span>
                            </span>
                        </label>

                        <!-- Selected canned response preview -->
                        <div id="canned-response-preview" class="hidden ml-7 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-medium text-blue-900" id="selected-canned-title">-</p>
                                    <p class="text-xs text-blue-700 mt-1 line-clamp-2" id="selected-canned-body">-</p>
                                </div>
                                <button type="button" onclick="openCannedModal()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    Change
                                </button>
                            </div>
                        </div>

                        <!-- Button to open picker (shown when canned is selected but none chosen) -->
                        <div id="canned-response-picker-btn" class="hidden ml-7">
                            <button type="button" onclick="openCannedModal()"
                                    class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                {% icon "chat-bubble-left-right" "w-4 h-4 mr-2" %}
                                Choose Template Message
                            </button>
                        </div>

                        <!-- Custom message option -->
                        <label class="flex items-start cursor-pointer">
                            <input type="radio" name="message_option" value="custom"
                                   onchange="selectMessageType('custom')"
                                   class="mt-1 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-3">
                                <span class="block text-sm font-medium text-gray-900">Write a custom message</span>
                                <span class="block text-xs text-gray-500">Type your own personalized message.</span>
                            </span>
                        </label>

                        <!-- Custom message textarea -->
                        <div id="custom-message-area" class="hidden ml-7">
                            <textarea name="custom_message" id="custom_message" rows="3"
                                      placeholder="Hi! Please review and sign this document..."
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Template Preview -->
                <div class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Template Details</h3>
                    <dl class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <dt class="text-gray-500">Name</dt>
                            <dd class="text-gray-900">{{ template.name }}</dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-gray-500">Type</dt>
                            <dd class="text-gray-900">{{ template.get_template_type_display }}</dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-gray-500">For</dt>
                            <dd class="text-gray-900">{{ template.get_target_party_type_display }}s</dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-gray-500">Version</dt>
                            <dd class="text-gray-900">{{ template.version }}</dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-gray-500">Requires Signature</dt>
                            <dd class="text-gray-900">{% if template.requires_signature %}Yes{% else %}No{% endif %}</dd>
                        </div>
                    </dl>
                </div>

                <!-- Info Box -->
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex">
                        <svg class="h-5 w-5 text-blue-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                        <div class="text-sm text-blue-700">
                            <p class="font-medium">What happens next?</p>
                            <p class="mt-1">A signing request will be created. The recipient will be able to review and sign the agreement using the generated link. You'll be able to track the signing status from the Signable Agreements list.</p>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex justify-end space-x-3">
                    <a href="{% url 'diveops:agreement-template-detail' pk=template.pk %}"
                       class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </a>
                    <button type="submit"
                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        {% icon "send" "w-4 h-4 mr-2" %}
                        Send Agreement
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Canned Response Picker Modal -->
<div id="canned-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeCannedModal()"></div>

        <!-- Modal panel -->
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
            <!-- Header -->
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900" id="modal-title">
                        Choose Template Message
                    </h3>
                    <button type="button" onclick="closeCannedModal()" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <!-- Search -->
                <div class="mt-3">
                    <input type="text" id="canned-search" placeholder="Search templates..."
                           oninput="filterCannedResponses(this.value)"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
            </div>

            <!-- Content -->
            <div class="px-6 py-4 max-h-96 overflow-y-auto">
                <div id="canned-list" class="space-y-3">
                    {% for response in canned_responses %}
                    <div class="canned-item p-4 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 cursor-pointer transition-colors"
                         data-id="{{ response.pk }}"
                         data-title="{{ response.title }}"
                         data-body="{{ response.body|truncatechars:200 }}"
                         data-search="{{ response.title|lower }} {{ response.body|lower }}"
                         onclick="selectCannedResponse('{{ response.pk }}', '{{ response.title|escapejs }}', '{{ response.body|truncatechars:150|escapejs }}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <h4 class="text-sm font-medium text-gray-900">{{ response.title }}</h4>
                                <p class="mt-1 text-xs text-gray-500 line-clamp-2">{{ response.body|truncatechars:150 }}</p>
                                {% if response.tags.all %}
                                <div class="mt-2 flex flex-wrap gap-1">
                                    {% for tag in response.tags.all %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">
                                        {{ tag.name }}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="ml-4 flex-shrink-0">
                                <span class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200">
                                    Select
                                </span>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-8 text-gray-500">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                        </svg>
                        <p class="mt-2 text-sm">No template messages available.</p>
                        <p class="text-xs text-gray-400">Create canned responses in the CRM settings.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Footer -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end">
                <button type="button" onclick="closeCannedModal()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Track selected canned response
    let selectedCannedId = null;

    function selectMessageType(type) {
        const messageTypeInput = document.getElementById('message_type');
        const cannedPreview = document.getElementById('canned-response-preview');
        const cannedPickerBtn = document.getElementById('canned-response-picker-btn');
        const customMessageArea = document.getElementById('custom-message-area');

        messageTypeInput.value = type;

        // Hide all conditional areas first
        cannedPreview.classList.add('hidden');
        cannedPickerBtn.classList.add('hidden');
        customMessageArea.classList.add('hidden');

        if (type === 'canned') {
            // Show picker button or preview depending on whether one is selected
            if (selectedCannedId) {
                cannedPreview.classList.remove('hidden');
            } else {
                cannedPickerBtn.classList.remove('hidden');
            }
        } else if (type === 'custom') {
            customMessageArea.classList.remove('hidden');
        }
        // 'none' - all areas stay hidden
    }

    function openCannedModal() {
        const modal = document.getElementById('canned-modal');
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');

        // Focus on search
        setTimeout(() => {
            document.getElementById('canned-search').focus();
        }, 100);
    }

    function closeCannedModal() {
        const modal = document.getElementById('canned-modal');
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');

        // Clear search
        document.getElementById('canned-search').value = '';
        filterCannedResponses('');
    }

    function selectCannedResponse(id, title, body) {
        selectedCannedId = id;

        // Update hidden input
        document.getElementById('canned_response_id').value = id;

        // Update preview
        document.getElementById('selected-canned-title').textContent = title;
        document.getElementById('selected-canned-body').textContent = body;

        // Show preview, hide picker button
        document.getElementById('canned-response-preview').classList.remove('hidden');
        document.getElementById('canned-response-picker-btn').classList.add('hidden');

        // Close modal
        closeCannedModal();
    }

    function filterCannedResponses(query) {
        const items = document.querySelectorAll('.canned-item');
        const lowerQuery = query.toLowerCase().trim();

        items.forEach(item => {
            const searchText = item.dataset.search || '';
            if (lowerQuery === '' || searchText.includes(lowerQuery)) {
                item.classList.remove('hidden');
            } else {
                item.classList.add('hidden');
            }
        });
    }

    // Handle escape key to close modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('canned-modal');
            if (!modal.classList.contains('hidden')) {
                closeCannedModal();
            }
        }
    });
</script>
{% endblock %}
