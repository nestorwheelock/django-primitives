{% extends "portal_ui/base_staff.html" %}
{% load portal_ui_tags %}

{% block title %}{{ block.super }} - Dive Operations{% endblock %}

{% block header_actions %}
<!-- Weather Widget -->
<div class="relative" x-data="{ open: false }">
    <button @click="open = !open" class="flex items-center text-sm bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors" title="Wind Conditions">
        <!-- Wind icon with rotating arrow -->
        <svg id="wind-direction-icon" class="w-4 h-4 mr-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transform: rotate(0deg);">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
        <span id="wind-speed" class="font-medium">--</span>
        <span class="ml-1 text-xs text-gray-500">kts</span>
        <span id="wind-gust" class="ml-1 text-xs text-orange-500 hidden"></span>
        <svg class="w-3 h-3 ml-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
    </button>
    <!-- Forecast Dropdown -->
    <div x-show="open" @click.away="open = false" x-cloak
         class="absolute right-0 mt-2 w-96 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
        <div class="px-4 py-3 border-b border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-semibold text-gray-900">Weather Forecast</h3>
                    <p class="text-xs text-gray-500">Next 12 hours</p>
                </div>
                <div id="current-temp" class="text-2xl font-bold text-gray-700">--Â°</div>
            </div>
            <div id="current-conditions" class="mt-2 flex items-center text-sm text-gray-600">
                <span id="current-weather-icon" class="mr-2">--</span>
                <span id="current-weather-desc">Loading...</span>
            </div>
        </div>
        <div id="weather-forecast" class="max-h-80 overflow-y-auto p-2">
            <div class="text-center py-4 text-gray-400 text-sm">Loading forecast...</div>
        </div>
        <div class="px-4 py-2 border-t border-gray-100 bg-gray-50 rounded-b-lg">
            <div class="flex justify-between text-xs text-gray-500">
                <span>Data: Open-Meteo</span>
                <span id="weather-updated">--</span>
            </div>
        </div>
    </div>
</div>

<!-- Business Clock -->
<div class="flex items-center text-sm text-gray-600 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-200" title="Shop Local Time ({{ business_timezone }})">
    <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <span id="business-clock" class="font-mono font-medium">--:--:--</span>
    <span class="ml-1.5 text-xs text-gray-400">{{ business_timezone_abbrev }}</span>
</div>

<script>
(function() {
    // Clock
    const tz = "{{ business_timezone|default:'UTC' }}";
    const clockEl = document.getElementById('business-clock');

    function updateClock() {
        const now = new Date();
        const options = {
            timeZone: tz,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        };
        clockEl.textContent = now.toLocaleTimeString('en-US', options);
    }
    updateClock();
    setInterval(updateClock, 1000);

    // Weather
    const lat = {{ dive_shop_latitude|default:0 }};
    const lon = {{ dive_shop_longitude|default:0 }};

    function msToKnots(ms) {
        return (ms * 1.944).toFixed(0);
    }

    function degToCompass(deg) {
        const dirs = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
        return dirs[Math.round(deg / 22.5) % 16];
    }

    function getWindColor(knots) {
        if (knots < 10) return 'text-green-600';
        if (knots < 15) return 'text-yellow-600';
        if (knots < 20) return 'text-orange-500';
        return 'text-red-600';
    }

    function getWindBg(knots) {
        if (knots < 10) return 'bg-green-50 border-green-200';
        if (knots < 15) return 'bg-yellow-50 border-yellow-200';
        if (knots < 20) return 'bg-orange-50 border-orange-200';
        return 'bg-red-50 border-red-200';
    }

    // Weather code to icon/description mapping (WMO codes)
    function getWeatherInfo(code, isDay) {
        const weather = {
            0: { icon: isDay ? 'â˜€ï¸' : 'ðŸŒ™', desc: 'Clear sky' },
            1: { icon: isDay ? 'ðŸŒ¤ï¸' : 'ðŸŒ™', desc: 'Mainly clear' },
            2: { icon: 'â›…', desc: 'Partly cloudy' },
            3: { icon: 'â˜ï¸', desc: 'Overcast' },
            45: { icon: 'ðŸŒ«ï¸', desc: 'Fog' },
            48: { icon: 'ðŸŒ«ï¸', desc: 'Freezing fog' },
            51: { icon: 'ðŸŒ§ï¸', desc: 'Light drizzle' },
            53: { icon: 'ðŸŒ§ï¸', desc: 'Drizzle' },
            55: { icon: 'ðŸŒ§ï¸', desc: 'Heavy drizzle' },
            61: { icon: 'ðŸŒ§ï¸', desc: 'Light rain' },
            63: { icon: 'ðŸŒ§ï¸', desc: 'Rain' },
            65: { icon: 'ðŸŒ§ï¸', desc: 'Heavy rain' },
            66: { icon: 'ðŸŒ¨ï¸', desc: 'Freezing rain' },
            67: { icon: 'ðŸŒ¨ï¸', desc: 'Heavy freezing rain' },
            71: { icon: 'ðŸŒ¨ï¸', desc: 'Light snow' },
            73: { icon: 'ðŸŒ¨ï¸', desc: 'Snow' },
            75: { icon: 'ðŸŒ¨ï¸', desc: 'Heavy snow' },
            80: { icon: 'ðŸŒ¦ï¸', desc: 'Light showers' },
            81: { icon: 'ðŸŒ¦ï¸', desc: 'Showers' },
            82: { icon: 'â›ˆï¸', desc: 'Heavy showers' },
            85: { icon: 'ðŸŒ¨ï¸', desc: 'Snow showers' },
            86: { icon: 'ðŸŒ¨ï¸', desc: 'Heavy snow showers' },
            95: { icon: 'â›ˆï¸', desc: 'Thunderstorm' },
            96: { icon: 'â›ˆï¸', desc: 'Thunderstorm + hail' },
            99: { icon: 'â›ˆï¸', desc: 'Severe thunderstorm' }
        };
        return weather[code] || { icon: 'â“', desc: 'Unknown' };
    }

    function getPrecipColor(mm) {
        if (mm === 0) return 'text-gray-400';
        if (mm < 1) return 'text-blue-400';
        if (mm < 5) return 'text-blue-600';
        return 'text-blue-800';
    }

    async function fetchWeather() {
        if (!lat || !lon) return;

        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,precipitation,precipitation_probability,weather_code,cloud_cover,wind_speed_10m,wind_direction_10m,wind_gusts_10m,is_day&current=temperature_2m,weather_code,is_day&timezone=${encodeURIComponent(tz)}&forecast_days=2&temperature_unit=fahrenheit`;
            const resp = await fetch(url);
            const data = await resp.json();

            if (data.hourly && data.current) {
                const now = new Date();
                const currentHour = now.getHours();

                // Current conditions from API
                const currentTemp = Math.round(data.current.temperature_2m);
                const currentCode = data.current.weather_code;
                const isDay = data.current.is_day;
                const currentWeather = getWeatherInfo(currentCode, isDay);

                // Update current header
                document.getElementById('current-temp').textContent = currentTemp + 'Â°F';
                document.getElementById('current-weather-icon').textContent = currentWeather.icon;
                document.getElementById('current-weather-desc').textContent = currentWeather.desc;

                // Current wind
                const windSpeed = msToKnots(data.hourly.wind_speed_10m[currentHour]);
                const windDir = data.hourly.wind_direction_10m[currentHour];
                const windGust = msToKnots(data.hourly.wind_gusts_10m[currentHour]);

                // Update wind display
                document.getElementById('wind-speed').textContent = windSpeed;
                document.getElementById('wind-speed').className = 'font-medium ' + getWindColor(windSpeed);
                document.getElementById('wind-direction-icon').style.transform = `rotate(${windDir}deg)`;
                document.getElementById('wind-direction-icon').className = 'w-4 h-4 mr-2 transition-transform ' + getWindColor(windSpeed);

                // Show gusts if significant
                const gustEl = document.getElementById('wind-gust');
                if (windGust > windSpeed * 1.3) {
                    gustEl.textContent = `G${windGust}`;
                    gustEl.classList.remove('hidden');
                }

                // Build forecast table
                let forecastHtml = `
                    <div class="grid grid-cols-7 gap-1 px-2 py-1 text-xs font-medium text-gray-500 border-b mb-1">
                        <span>Time</span>
                        <span class="text-center">Sky</span>
                        <span class="text-center">Temp</span>
                        <span class="text-center">Rain</span>
                        <span class="text-center">Wind</span>
                        <span class="text-center">Dir</span>
                        <span class="text-center">Gust</span>
                    </div>
                    <div class="space-y-1">
                `;
                for (let i = 0; i < 12; i++) {
                    const hourIndex = currentHour + i;
                    if (hourIndex >= data.hourly.time.length) break;

                    const speed = msToKnots(data.hourly.wind_speed_10m[hourIndex]);
                    const dir = data.hourly.wind_direction_10m[hourIndex];
                    const gust = msToKnots(data.hourly.wind_gusts_10m[hourIndex]);
                    const temp = Math.round(data.hourly.temperature_2m[hourIndex]);
                    const precip = data.hourly.precipitation[hourIndex];
                    const precipProb = data.hourly.precipitation_probability[hourIndex];
                    const weatherCode = data.hourly.weather_code[hourIndex];
                    const hourIsDay = data.hourly.is_day[hourIndex];
                    const weather = getWeatherInfo(weatherCode, hourIsDay);
                    const time = new Date(data.hourly.time[hourIndex]).toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        hour12: true,
                        timeZone: tz
                    });

                    forecastHtml += `
                        <div class="grid grid-cols-7 gap-1 items-center px-2 py-1.5 rounded ${getWindBg(speed)} border text-sm">
                            <span class="text-xs font-medium text-gray-600">${time}</span>
                            <span class="text-center" title="${weather.desc}">${weather.icon}</span>
                            <span class="text-center font-medium">${temp}Â°</span>
                            <span class="text-center ${getPrecipColor(precip)}" title="${precipProb}% chance">
                                ${precip > 0 ? precip.toFixed(1) + '"' : precipProb > 30 ? precipProb + '%' : '-'}
                            </span>
                            <span class="text-center font-bold ${getWindColor(speed)}">${speed}</span>
                            <span class="text-center text-xs text-gray-500">${degToCompass(dir)}</span>
                            <span class="text-center text-xs ${gust > speed * 1.2 ? 'text-orange-500 font-medium' : 'text-gray-400'}">
                                ${gust > speed * 1.2 ? gust : '-'}
                            </span>
                        </div>
                    `;
                }
                forecastHtml += '</div>';
                forecastHtml += `
                    <div class="mt-2 px-2 py-1 text-xs text-gray-500 border-t">
                        <span class="inline-block w-3 h-3 bg-green-100 border border-green-200 rounded mr-1"></span>&lt;10kts
                        <span class="inline-block w-3 h-3 bg-yellow-100 border border-yellow-200 rounded ml-2 mr-1"></span>10-15
                        <span class="inline-block w-3 h-3 bg-orange-100 border border-orange-200 rounded ml-2 mr-1"></span>15-20
                        <span class="inline-block w-3 h-3 bg-red-100 border border-red-200 rounded ml-2 mr-1"></span>&gt;20kts
                    </div>
                `;
                document.getElementById('weather-forecast').innerHTML = forecastHtml;
                document.getElementById('weather-updated').textContent = 'Updated: ' + now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            }
        } catch (err) {
            console.error('Weather fetch error:', err);
            document.getElementById('wind-speed').textContent = '--';
        }
    }

    // Fetch weather on load and every 10 minutes
    fetchWeather();
    setInterval(fetchWeather, 600000);
})();
</script>
{% endblock %}

{% block breadcrumb %}
<li>
    <div class="flex items-center">
        <svg class="w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <a href="{% url 'diveops:excursion-list' %}" class="ml-2 text-sm font-medium text-gray-500 hover:text-gray-700">
            Dive Operations
        </a>
    </div>
</li>
{% block extra_breadcrumb %}{% endblock %}
{% endblock %}
