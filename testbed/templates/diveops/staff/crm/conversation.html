{% extends "diveops/staff/_base.html" %}
{% load portal_ui_tags diveops_filters %}

{% block breadcrumb %}
<li>
    <div class="flex items-center">
        <svg class="flex-shrink-0 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <a href="{% url 'diveops:crm-inbox' %}" class="ml-2 text-sm font-medium text-gray-500 hover:text-gray-700">
            CRM Inbox
        </a>
    </div>
</li>
<li>
    <div class="flex items-center">
        <svg class="flex-shrink-0 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <span class="ml-2 text-sm font-medium text-gray-500">{{ conversation.subject|default:"Conversation"|truncatechars:30 }}</span>
    </div>
</li>
{% endblock %}

{% block staff_content %}
<div class="flex h-[calc(100vh-10rem)] gap-6">
    <!-- Left Column: Chat Thread -->
    <div class="flex-1 flex flex-col bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <!-- Chat Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center space-x-3">
                <a href="{% url 'diveops:crm-inbox' %}" class="text-gray-500 hover:text-gray-700">
                    {% icon "arrow-left" "w-5 h-5" %}
                </a>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">{{ conversation.subject|default:"Conversation" }}</h2>
                    <div class="flex items-center space-x-3 text-sm">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full
                            {% if conversation.status == 'active' %}bg-green-100 text-green-700
                            {% elif conversation.status == 'closed' %}bg-gray-100 text-gray-600
                            {% else %}bg-yellow-100 text-yellow-700{% endif %}">
                            {{ conversation.status|title }}
                        </span>
                        {% if conversation.assigned_to_user %}
                        <span class="text-gray-500">
                            Assigned to {{ conversation.assigned_to_user.first_name|default:conversation.assigned_to_user.email }}
                        </span>
                        {% else %}
                        <span class="text-yellow-600">Unassigned</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <!-- Assign Button -->
                <form method="post" action="{% url 'diveops:crm-assign' conversation_id=conversation.pk %}" class="inline">
                    {% csrf_token %}
                    {% if conversation.assigned_to_user == request.user %}
                    <input type="hidden" name="action" value="unassign">
                    <button type="submit" class="inline-flex items-center px-3 py-1.5 text-sm border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50">
                        {% icon "user-minus" "w-4 h-4 mr-1" %}
                        Unassign
                    </button>
                    {% elif not conversation.assigned_to_user %}
                    <input type="hidden" name="action" value="assign">
                    <button type="submit" class="inline-flex items-center px-3 py-1.5 text-sm border border-blue-300 rounded-lg text-blue-700 bg-blue-50 hover:bg-blue-100">
                        {% icon "user-plus" "w-4 h-4 mr-1" %}
                        Assign to Me
                    </button>
                    {% endif %}
                </form>

                <!-- Close/Reopen Button -->
                {% if conversation.status == 'active' %}
                <form method="post" action="{% url 'diveops:crm-close' conversation_id=conversation.pk %}" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="inline-flex items-center px-3 py-1.5 text-sm border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50">
                        {% icon "lock-closed" "w-4 h-4 mr-1" %}
                        Close
                    </button>
                </form>
                {% else %}
                <form method="post" action="{% url 'diveops:crm-reopen' conversation_id=conversation.pk %}" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="inline-flex items-center px-3 py-1.5 text-sm border border-green-300 rounded-lg text-green-700 bg-green-50 hover:bg-green-100">
                        {% icon "lock-open" "w-4 h-4 mr-1" %}
                        Reopen
                    </button>
                </form>
                {% endif %}
            </div>
        </div>

        <!-- Messages Area -->
        <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50" id="messages-container">
            {% if messages_list %}
                {% for msg in messages_list %}
                <div class="flex {% if msg.direction == 'outbound' %}justify-end{% else %}justify-start{% endif %}">
                    <div class="max-w-[75%]">
                        <div class="rounded-lg px-4 py-3 {% if msg.direction == 'outbound' %}bg-blue-600 text-white{% else %}bg-white shadow border border-gray-200 text-gray-800{% endif %}">
                            {% if msg.subject and msg.subject != conversation.subject %}
                            <p class="text-xs font-semibold mb-1 {% if msg.direction == 'outbound' %}text-blue-200{% else %}text-gray-500{% endif %}">
                                {{ msg.subject }}
                            </p>
                            {% endif %}
                            {% if msg.body_html %}
                            <div class="prose prose-sm max-w-none {% if msg.direction == 'outbound' %}prose-invert{% endif %}">
                                {{ msg.body_html|safe }}
                            </div>
                            {% else %}
                            <p class="text-sm whitespace-pre-wrap">{{ msg.body_text }}</p>
                            {% endif %}
                        </div>
                        <div class="mt-1 flex items-center space-x-2 {% if msg.direction == 'outbound' %}justify-end{% else %}justify-start{% endif %}">
                            <span class="text-xs text-gray-500 font-medium">
                                {% if msg.sender_person %}
                                    {{ msg.sender_person.first_name }} {{ msg.sender_person.last_name|slice:":1" }}.
                                {% else %}
                                    System
                                {% endif %}
                            </span>
                            <span class="text-xs text-gray-400">
                                {{ msg.created_at|date:"M j, g:i a" }}
                            </span>
                            {% if msg.channel != 'in_app' %}
                            <span class="text-xs text-gray-400 px-1.5 py-0.5 bg-gray-100 rounded">
                                via {{ msg.channel }}
                            </span>
                            {% endif %}
                            <span class="text-xs px-1.5 py-0.5 rounded
                                {% if msg.direction == 'inbound' %}bg-blue-100 text-blue-600{% else %}bg-gray-100 text-gray-500{% endif %}">
                                {{ msg.direction }}
                            </span>
                        </div>
                        {% comment %}Messenger-style read indicator - show small avatar under last read outbound message{% endcomment %}
                        {% if msg.direction == 'outbound' and last_read_outbound_message_id %}
                            {% if msg.pk|stringformat:"s" == last_read_outbound_message_id %}
                            <div class="flex justify-end mt-1">
                                <div class="flex items-center" title="Seen by {{ customer_person.first_name }}">
                                    {% if diver and diver.profile_photo %}
                                    <img src="{{ diver.profile_photo.file.url }}" alt="Seen" class="w-4 h-4 rounded-full object-cover border border-white shadow-sm">
                                    {% else %}
                                    <div class="w-4 h-4 rounded-full bg-blue-100 flex items-center justify-center border border-white shadow-sm">
                                        <span class="text-[8px] font-bold text-blue-600">
                                            {{ customer_person.first_name|slice:":1"|upper }}
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="text-center py-8">
                <div class="text-gray-400 mb-4">
                    {% icon "chat-bubble-left-ellipsis" "w-12 h-12 mx-auto" %}
                </div>
                <p class="text-gray-500">No messages in this conversation yet.</p>
            </div>
            {% endif %}
        </div>

        <!-- Reply Input -->
        {% if conversation.status == 'active' %}
        <div class="px-4 py-4 border-t border-gray-200 bg-white">
            <form method="post" class="flex items-end space-x-3">
                {% csrf_token %}
                <div class="flex-1">
                    <label for="message" class="sr-only">Your reply</label>
                    <textarea
                        name="message"
                        id="message"
                        rows="3"
                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 resize-none text-sm"
                        placeholder="Type your reply..."
                        required
                    ></textarea>
                </div>
                <button
                    type="submit"
                    class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
                >
                    {% icon "paper-airplane" "w-5 h-5 mr-1" %}
                    Send
                </button>
            </form>
        </div>
        {% else %}
        <div class="px-4 py-4 border-t border-gray-200 bg-gray-100 text-center">
            <p class="text-gray-500 text-sm">
                This conversation is {{ conversation.status }}.
                <form method="post" action="{% url 'diveops:crm-reopen' conversation_id=conversation.pk %}" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="text-blue-600 hover:underline">Reopen</button>
                </form>
                to reply.
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Right Column: Customer Context Panel -->
    <div class="w-80 flex-shrink-0 space-y-4 overflow-y-auto">
        <!-- Customer Info Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                <h3 class="text-sm font-semibold text-gray-900">Customer</h3>
            </div>
            <div class="p-4">
                {% if customer_person %}
                <div class="flex items-center space-x-3 mb-4">
                    {% if diver and diver.profile_photo %}
                    <img src="{{ diver.profile_photo.file.url }}" alt="{{ customer_person.first_name }}" class="w-12 h-12 rounded-full object-cover">
                    {% else %}
                    <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                        <span class="text-lg font-bold text-blue-600">
                            {{ customer_person.first_name|slice:":1"|upper }}{{ customer_person.last_name|slice:":1"|upper }}
                        </span>
                    </div>
                    {% endif %}
                    <div>
                        <p class="font-medium text-gray-900">
                            {{ customer_person.first_name }} {{ customer_person.last_name }}
                        </p>
                        {% if customer_person.email %}
                        <p class="text-sm text-gray-500">{{ customer_person.email }}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="space-y-2 text-sm">
                    {% if customer_person.phone %}
                    <div class="flex items-center text-gray-600">
                        {% icon "phone" "w-4 h-4 mr-2 text-gray-400" %}
                        <a href="tel:{{ customer_person.phone }}" class="hover:text-blue-600">{{ customer_person.phone }}</a>
                    </div>
                    {% endif %}
                    {% if customer_person.email %}
                    <div class="flex items-center text-gray-600">
                        {% icon "mail" "w-4 h-4 mr-2 text-gray-400" %}
                        <a href="mailto:{{ customer_person.email }}" class="hover:text-blue-600">{{ customer_person.email }}</a>
                    </div>
                    {% endif %}
                </div>

                {% if diver %}
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <a href="{% url 'diveops:diver-detail' pk=diver.pk %}" class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800">
                        {% icon "identification" "w-4 h-4 mr-1" %}
                        View Diver Profile
                        {% icon "arrow-right" "w-3 h-3 ml-1" %}
                    </a>
                </div>
                {% endif %}
                {% else %}
                <p class="text-sm text-gray-500">Customer information not available</p>
                {% endif %}
            </div>
        </div>

        <!-- Diver Details (if available) -->
        {% if diver %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                <h3 class="text-sm font-semibold text-gray-900">Diver Details</h3>
            </div>
            <div class="p-4 space-y-3">
                {% if diver.certification_level %}
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">Certification</span>
                    <span class="font-medium text-gray-900">{{ diver.certification_level }}</span>
                </div>
                {% endif %}
                {% if diver.total_logged_dives %}
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">Total Dives</span>
                    <span class="font-medium text-gray-900">{{ diver.total_logged_dives }}</span>
                </div>
                {% endif %}
                {% if diver.medical_clearance_valid_until %}
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">Medical Valid</span>
                    <span class="font-medium {% if diver.medical_clearance_valid_until < today %}text-red-600{% else %}text-gray-900{% endif %}">
                        {{ diver.medical_clearance_valid_until|date:"M j, Y" }}
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Customer Read Status -->
        {% if customer_participant %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                <h3 class="text-sm font-semibold text-gray-900">Message Status</h3>
            </div>
            <div class="p-4 space-y-3 text-sm">
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Customer has read:</span>
                    {% if customer_participant.has_unread %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 font-medium">
                        {% icon "eye-slash" "w-3.5 h-3.5 mr-1" %}
                        {{ customer_participant.unread_count }} unread
                    </span>
                    {% else %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-medium">
                        {% icon "check" "w-3.5 h-3.5 mr-1" %}
                        All read
                    </span>
                    {% endif %}
                </div>
                {% if customer_participant.last_read_at %}
                <div class="flex items-center justify-between text-gray-500">
                    <span>Last seen:</span>
                    <span>{{ customer_participant.last_read_at|timesince }} ago</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Notification Status -->
        {% if notification_status %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                <h3 class="text-sm font-semibold text-gray-900">Notification Channels</h3>
            </div>
            <div class="p-4 space-y-2 text-sm">
                {% if notification_status.push_enabled %}
                <div class="flex items-center text-green-600">
                    {% icon "bell" "w-4 h-4 mr-2" %}
                    <span>Push enabled ({{ notification_status.push_subscription_count }} device{{ notification_status.push_subscription_count|pluralize }})</span>
                </div>
                {% else %}
                <div class="flex items-center text-gray-400">
                    {% icon "bell-slash" "w-4 h-4 mr-2" %}
                    <span>No push subscription</span>
                </div>
                {% endif %}

                {% if notification_status.email_available %}
                <div class="flex items-center text-green-600">
                    {% icon "mail" "w-4 h-4 mr-2" %}
                    <span>Email available</span>
                </div>
                {% else %}
                <div class="flex items-center text-gray-400">
                    {% icon "mail" "w-4 h-4 mr-2" %}
                    <span>No email</span>
                </div>
                {% endif %}

                {% if notification_status.sms_available %}
                <div class="flex items-center text-green-600">
                    {% icon "device-phone-mobile" "w-4 h-4 mr-2" %}
                    <span>SMS available</span>
                </div>
                {% else %}
                <div class="flex items-center text-gray-400">
                    {% icon "device-phone-mobile" "w-4 h-4 mr-2" %}
                    <span>No phone</span>
                </div>
                {% endif %}

                <div class="pt-2 border-t border-gray-200 mt-2">
                    <span class="text-gray-500">Primary channel:</span>
                    <span class="font-medium text-gray-900 ml-1">
                        {% if notification_status.primary_channel == 'push' %}
                            {% icon "bell" "w-4 h-4 inline mr-1 text-blue-500" %}Push
                        {% elif notification_status.primary_channel == 'email' %}
                            {% icon "mail" "w-4 h-4 inline mr-1 text-blue-500" %}Email
                        {% elif notification_status.primary_channel == 'sms' %}
                            {% icon "device-phone-mobile" "w-4 h-4 inline mr-1 text-blue-500" %}SMS
                        {% else %}
                            None
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Related Object (if any) -->
        {% if related_object %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                <h3 class="text-sm font-semibold text-gray-900">Related To</h3>
            </div>
            <div class="p-4">
                <div class="text-sm">
                    <span class="text-gray-500">{{ related_object|class_name }}:</span>
                    <p class="font-medium text-gray-900 mt-1">{{ related_object }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Conversation Metadata -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                <h3 class="text-sm font-semibold text-gray-900">Conversation Info</h3>
            </div>
            <div class="p-4 space-y-3 text-sm">
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Started</span>
                    <span class="text-gray-900">{{ conversation.created_at|date:"M j, Y g:i a" }}</span>
                </div>
                {% if conversation.last_message_at %}
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Last Message</span>
                    <span class="text-gray-900">{{ conversation.last_message_at|timesince }} ago</span>
                </div>
                {% endif %}
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Messages</span>
                    <span class="text-gray-900">{{ messages_list|length }}</span>
                </div>
                {% if conversation.primary_channel %}
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Primary Channel</span>
                    <span class="text-gray-900">{{ conversation.primary_channel|title }}</span>
                </div>
                {% endif %}
                {% if conversation.closed_at %}
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Closed</span>
                    <span class="text-gray-900">{{ conversation.closed_at|date:"M j, Y g:i a" }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Auto-scroll to bottom of messages on load
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('messages-container');
    if (container) {
        container.scrollTop = container.scrollHeight;
    }
});
</script>
{% endblock %}
